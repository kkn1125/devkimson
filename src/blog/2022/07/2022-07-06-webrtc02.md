---
slug: "/webrtc02"
layout: post
date: 2022-07-06 22:12:46 +0900
title: "[WEBRTC] node.js express + React + WebRTC + WebSocket 환경 구축하기 02"
author: Kimson
categories: [software]
image: /images/post/covers/TIL-center.png
tags: [notion, til]
description: ""
featured: true
hidden: false
rating: 4.5
toc: true
profile: false
istop: true
keysum: false
keywords: ""
published: true
---

# 양방향 영상출력을 해보자

회사에서 영상관련 프로젝트로 인해 `ffmpeg`와 `webrtc`를 처음 접하게 되었습니다. `WebRTC` 내용이 워낙에 어렵고 레퍼런스도 적은데다 기술 발표자료가 즐비할 뿐 영상강좌는 외국 분들이 올린 것이 전부였습니다.

물론 더 찾아보면 있을 수 있지만 단기간에 빨리 익혀야하는게 슬픈 현실...

이것저것 참고한 것들과 작업한 결과물과 작업하면서 겪은 오류 상황 및 문제해결을 기록하려합니다.

## WebRTC API를 들여다 보자

[이전 포스팅](https://kkn1125.github.io/webrtc01)에서 react에서 webrtc를 사용해서 간단한 영상출력까지 해보았습니다. 이번에는 채팅룸을 만들어 상대방이 접속하면 서로 영상을 출력하는 것을 구현하려합니다.

먼저 알아야하는 것은 `WebRTC API`에 관한 내용인데요, `WebRTC API`는 그렇게 많지 않고 `MDN web docs`에 설명이 굉장히 잘 되어 있습니다. 다만, 처음 접할 때는 당연히 잘 정리된 말도 어렵게 느껴지기 마련이지요.

포스팅 내용이 주관적인 공부 패턴을 기준으로 하기 때문에 내용이 뒤죽박죽이어도 양해바랍니다 🥲

### RTCPeerConnection

제일 중요한 인터페이스라고 말하고 싶은 녀석입니다. `RTCPeerConnection` 생성자를 통해 만든 인스턴스를 자주 다룰 것 입니다. 제일 핵심이라고 해도 과언이 아니라 생각합니다.

```js
const pc = new RTCPeerConnection();
```

위와 같이 생성자를 통해 인스턴스를 만드는데요, 이때 pc 변수는 datachannel이나 이벤트, icecandidate를 추가 하는 등의 행위를 하게 해주는 핵심적인 기능을 담당합니다. WebRTC는 시그널링 서버를 필요로 하는데 시그널링을 지원하지 않으며, socket.io라는 WebSocket library를 사용해야 합니다.

미디어를 주고 받는 흐름을 알면 나중에 어떤 방식으로 무엇부터 해야하는지 감이 잡히기 때문에 흐름도를 보겠습니다.

<figure class="text-center">
<span class="w-inline-block">
   <img src="https://user-images.githubusercontent.com/71887242/177593218-5a772304-d7c0-4ac7-96bb-73993d4ed8bd.png" alt="sample" title="sample">
   <figcaption>흐름도</figcaption>
</span>
</figure>

순서를 나열해보면 다음과 같습니다.

1. 유저가 접속한다.
2. getUserMedia로 카메라 권한 요청을 한다.
3. peerConnection에서 localDescription을 작성한다.
4. dataChannel 생성
5. createOffer
6. sendOffer
7. socket에서 다른 사용자에게 broadcast로 offer를 전달한다.
8. 받은 offer를 remoteDescription에 넣는다.
9. createAnswer
10. localDescription을 작성한다.
11. sendAnswer
12. socket에서 다른 사용자에게 broadcast로 answer를 전달한다.
13. 받은 answer를 remoteDescription에 넣는다.
14. iceCandidate 이벤트가 발생하는 영역에서 socket에 iceCandidates를 전송한다.
15. onTrack 이벤트가 발생하고, 해당 트랙을 remoteVideo의 srcObject에 넣는다.
16. 다른 사용자 또한 iceCandidates 이벤트 발생 시 상대방에게 iceCandidates를 전송한다.
17. 결과적으로 서로 영상 교환이 되어 양방향 출력이 된다.

아직 정리가 완전히 된 내용이 아니기 때문에 서로 하나씩 교환한다고 생각하시면 됩니다.

offer가 만들어지고 전송되면 answer로 응답해주고, 각자 localDescription, remoteDescription이 작성되면 이후 iceCandidate를 주고 받습니다.

그 과정에서 onTrack 이벤트를 설정해서 각 remoteVideo에 출력시키는 흐름입니다.

<!-- ## 코드로 작성해보자

> 환경 구축이 안되어 있다면 [이전 포스팅](https://kkn1125.github.io/webrtc01)을 먼저 보고 오시기 바랍니다.

하나씩 만들어가면서 익혀볼텐데요, RTCPeerConnection이 무엇인지, iceCandidate는 무엇인지, offer와 answer, description 작성, on* 이벤트는 무엇이 있는지, socket.io 에서 주로 어떤 api를 사용하는지는 모두 자세히 알아야 가능한 것은 아니지만 최소한으로는 알아두어야 합니다. 알고 쓰는 것과 모르고 쓰는 것은 천지차이니까요. -->



소스코드가 완전히 정리되지 않아 저장소 링크를 남겨두겠습니다. 처음 접하시는 분은 참고하여 보시면 되겠습니다.

> 더 나은 가독성을 위해 소스코드 정리가 끝나는데로 각 부분 뽑아서 포스팅 내용을 추가, 수정할 예정이니 양해바랍니다 🙇‍♂️

---

📚 함께 보면 좋은 내용

[MDN web docs::WebRTC API](https://developer.mozilla.org/ko/docs/Web/API/WebRTC_API)

[kkn1125::github repository](https://github.com/kkn1125/webrtc-react)

[dondido::github repository](https://github.com/dondido/webrtc-video-room)